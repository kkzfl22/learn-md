# K8S笔记

## Kubernetes安装

**硬件要求**

| 硬件 | 要求    |
| ---- | ------- |
| CPU  | 至少2核 |
| 内存 | 至少3G  |
| 硬件 | 至少50G |

**节点信息**

| 主机名        | IP           |
| ------------- | ------------ |
| k8s-master-50 | 192.168.5.50 |
| k8s-node-51   | 192.168.5.51 |
| k8s-node-52   | 192.168.5.52 |
| k8s-node-53   | 192.168.5.53 |

系统要求：

推荐使用centos7.7及以上版本

国内建议使用阿里云下载

```http
http://mirrors.aliyun.com/centos/7/isos/x86_64/
```

### 配制阿里云yum源

```sh
# 1. 下载安装wget
yum install -y wget

#2.备份默认的yum
mv /etc/yum.repos.d /etc/yum.repos.d.backup

#3.设置新的yum目录
mkdir -p /etc/yum.repos.d

#4.下载阿里yum配置到该目录中，选择对应版本
wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo

#5.更新epel源为阿里云epel源
mv /etc/yum.repos.d/epel.repo /etc/yum.repos.d/epel.repo.backup
mv /etc/yum.repos.d/epel-testing.repo /etc/yum.repos.d/epel-testing.repo.backup

wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo

#6.重建缓存
yum clean all
yum makecache

#7.看一下yum仓库有多少包
yum repolist
yum update
```

可以做一个系统快照版本，防止后面的翻车，以做好回滚，不用从头开始。做系统快照建议关机做，关机后的快照特别小。

### 升级系统内核

默认此处安装的7.9版本，内核版本为3.10，需要做下升级,此安装完成后，系统内核版本需要升级到了`4.4`，但别太高，不然操作不一致。

```sh
# 导入仓库源
rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm

# 查看可安装的软件包
yum --enablerepo="elrepo-kernel" list --showduplicates | sort -r | grep kernel-lt.x86_64

# 升级到最新内核版本的方法
yum --enablerepo=elrepo-kernel install -y kernel-lt


grep initrd16 /boot/grub2/grub.cfg
grub2-set-default 0

reboot
```

### 查看相关的系统信息

```sh
# 查看centos系统内核命令
uname -r
uname -a

# 查看CPU
lscpu

# 查看内存
free 
free -g

# 查看硬盘信息
fdisk -l
```

### centos7系统配制

```sh
# 1. 开发环境可以直接关闭防火墙，但生产环境，切记，万不能关
systemctl stop firewalld
systemctl disable firewalld


# 2. 关闭selinux
sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/sysconfig/selinux
setenforce 0


# 3. 网桥过滤
vi /etc/sysctl.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-arptables = 1
net.ipv4.ip_forward=1
net.ipv4.ip_forward_use_pmtu = 0
#生效命令
sysctl --system
#查看效果
sysctl -a|grep "ip_forward"



# 4.  开启IPVS
#安装IPVS
yum -y install ipset ipvsadm -y
#编译ipvs.modules文件
vi /etc/sysconfig/modules/ipvs.modules
#文件内容如下
#!/bin/bash
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack
# 在4.4内核版本中使用nf_conntrack_ipv4
modprobe -- nf_conntrack_ipv4
#赋予权限并执行
chmod 755 /etc/sysconfig/modules/ipvs.modules && bash /etc/sysconfig/modules/ipvs.modules && lsmod | grep -e ip_vs -e nf_conntrack
#重启电脑，检查是否生效
reboot
lsmod | grep ip_vs_rr



# 5. 同步时间
#安装软件
yum -y install ntpdate
#向阿里云服务器同步时间
ntpdate time1.aliyun.com
#删除本地时间并设置时区为上海
rm -rf /etc/localtime
ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
#查看时间
date -R || date



# 6.命令补全
#安装bash-completion
yum -y install bash-completion bash-completion-extras
#使用bash-completion
source /etc/profile.d/bash_completion.sh



# 7. 关闭swap分区
#临时关闭：
swapoff -a
#永久关闭：
vi /etc/fstab
将文件中的/dev/mapper/centos-swap这行代码注释掉
#/dev/mapper/centos-swap swap swap defaults 0 0
#确认swap已经关闭：若swap行都显示 0 则表示关闭成功
free -m


# 8. hosts配置
#文件内容如下:
cat <<EOF >> /etc/hosts
192.168.5.50 k8s-master-50
192.168.5.51 k8s-node-51
192.168.5.52 k8s-node-52
192.168.5.53 k8s-node-53
EOF

cat /etc/hosts
```

### 安装docker



