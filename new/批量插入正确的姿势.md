# 13 ç§’æ’å…¥ 30 ä¸‡æ¡æ•°æ®ï¼Œè¿™æ‰æ˜¯æ‰¹é‡æ’å…¥æ­£ç¡®çš„å§¿åŠ¿ï¼



[æ¥æºï¼šblog.csdn.net/qq_35427589/
article/details/129665307](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect)

- [30ä¸‡æ¡æ•°æ®æ’å…¥æ’å…¥æ•°æ®åº“éªŒè¯](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&chksm=fa496f8ecd3ee698f4954c00efb80fe955ec9198fff3ef4011e331aa37f55a6a17bc8c0335a8&scene=21&token=899450012&lang=zh_CN#wechat_redirect)
- [å®ä½“ç±»ã€mapperå’Œé…ç½®æ–‡ä»¶å®šä¹‰](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&chksm=fa496f8ecd3ee698f4954c00efb80fe955ec9198fff3ef4011e331aa37f55a6a17bc8c0335a8&scene=21&token=899450012&lang=zh_CN#wechat_redirect)
- [ä¸åˆ†æ‰¹æ¬¡ç›´æ¥æ¢­å“ˆ](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&chksm=fa496f8ecd3ee698f4954c00efb80fe955ec9198fff3ef4011e331aa37f55a6a17bc8c0335a8&scene=21&token=899450012&lang=zh_CN#wechat_redirect)
- [å¾ªç¯é€æ¡æ’å…¥](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&chksm=fa496f8ecd3ee698f4954c00efb80fe955ec9198fff3ef4011e331aa37f55a6a17bc8c0335a8&scene=21&token=899450012&lang=zh_CN#wechat_redirect)
- [MyBatiså®ç°æ’å…¥30ä¸‡æ¡æ•°æ®](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&chksm=fa496f8ecd3ee698f4954c00efb80fe955ec9198fff3ef4011e331aa37f55a6a17bc8c0335a8&scene=21&token=899450012&lang=zh_CN#wechat_redirect)
- [JDBCå®ç°æ’å…¥30ä¸‡æ¡æ•°æ®](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&chksm=fa496f8ecd3ee698f4954c00efb80fe955ec9198fff3ef4011e331aa37f55a6a17bc8c0335a8&scene=21&token=899450012&lang=zh_CN#wechat_redirect)
- [æ€»ç»“](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&chksm=fa496f8ecd3ee698f4954c00efb80fe955ec9198fff3ef4011e331aa37f55a6a17bc8c0335a8&scene=21&token=899450012&lang=zh_CN#wechat_redirect)

------

æœ¬æ–‡ä¸»è¦è®²è¿°é€šè¿‡MyBatisã€JDBCç­‰åšå¤§æ•°æ®é‡æ•°æ®æ’å…¥çš„æ¡ˆä¾‹å’Œç»“æœã€‚

## **[30ä¸‡æ¡æ•°æ®æ’å…¥æ’å…¥æ•°æ®åº“éªŒè¯](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect)**

- å®ä½“ç±»ã€mapperå’Œé…ç½®æ–‡ä»¶å®šä¹‰

- - Userå®ä½“
  - mapperæ¥å£
  - mapper.xmlæ–‡ä»¶
  - jdbc.properties
  - sqlMapConfig.xml

- ä¸åˆ†æ‰¹æ¬¡ç›´æ¥æ¢­å“ˆ

- å¾ªç¯é€æ¡æ’å…¥

- MyBatiså®ç°æ’å…¥30ä¸‡æ¡æ•°æ®

- JDBCå®ç°æ’å…¥30ä¸‡æ¡æ•°æ®

- æ€»ç»“

éªŒè¯çš„æ•°æ®åº“è¡¨ç»“æ„å¦‚ä¸‹ï¼š

```
CREATE TABLE `t_user` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'ç”¨æˆ·id',
  `username` varchar(64) DEFAULT NULL COMMENT 'ç”¨æˆ·åç§°',
  `age` int(4) DEFAULT NULL COMMENT 'å¹´é¾„',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='ç”¨æˆ·ä¿¡æ¯è¡¨';
```

è¯ä¸å¤šè¯´ï¼Œå¼€æ•´ï¼

> åŸºäº Spring Boot + MyBatis Plus + Vue & Element å®ç°çš„åå°ç®¡ç†ç³»ç»Ÿ + ç”¨æˆ·å°ç¨‹åºï¼Œæ”¯æŒ RBAC åŠ¨æ€æƒé™ã€å¤šç§Ÿæˆ·ã€æ•°æ®æƒé™ã€å·¥ä½œæµã€ä¸‰æ–¹ç™»å½•ã€æ”¯ä»˜ã€çŸ­ä¿¡ã€å•†åŸç­‰åŠŸèƒ½
>
> - é¡¹ç›®åœ°å€ï¼šhttps://github.com/YunaiV/ruoyi-vue-pro
> - è§†é¢‘æ•™ç¨‹ï¼šhttps://doc.iocoder.cn/video/

## **[å®ä½“ç±»ã€mapperå’Œé…ç½®æ–‡ä»¶å®šä¹‰](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect)**

Userå®ä½“

```
/**
 * <p>ç”¨æˆ·å®ä½“</p>
 *
 * @Author zjq
 */
@Data
public class User {

    private int id;
    private String username;
    private int age;

}
```

mapperæ¥å£

```
public interface UserMapper {

    /**
     * æ‰¹é‡æ’å…¥ç”¨æˆ·
     * @param userList
     */
    void batchInsertUser(@Param("list") List<User> userList);


}
```

mapper.xmlæ–‡ä»¶

```
<!-- æ‰¹é‡æ’å…¥ç”¨æˆ·ä¿¡æ¯ -->
<insert id="batchInsertUser" parameterType="java.util.List">
    insert into t_user(username,age) values
    <foreach collection="list" item="item" index="index" separator=",">
        (
        #{item.username},
        #{item.age}
        )
    </foreach>
</insert>
```

jdbc.properties

```
jdbc.driver=com.mysql.jdbc.Driver
jdbc.url=jdbc:mysql://localhost:3306/test
jdbc.username=root
jdbc.password=root
```

sqlMapConfig.xml

```
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>

    <!--é€šè¿‡propertiesæ ‡ç­¾åŠ è½½å¤–éƒ¨propertiesæ–‡ä»¶-->
    <properties resource="jdbc.properties"></properties>


    <!--è‡ªå®šä¹‰åˆ«å-->
    <typeAliases>
        <typeAlias type="com.zjq.domain.User" alias="user"></typeAlias>
    </typeAliases>


    <!--æ•°æ®æºç¯å¢ƒ-->
    <environments default="developement">
        <environment id="developement">
            <transactionManager type="JDBC"></transactionManager>
            <dataSource type="POOLED">
                <property name="driver" value="${jdbc.driver}"/>
                <property name="url" value="${jdbc.url}"/>
                <property name="username" value="${jdbc.username}"/>
                <property name="password" value="${jdbc.password}"/>
            </dataSource>
        </environment>
    </environments>


    <!--åŠ è½½æ˜ å°„æ–‡ä»¶-->
    <mappers>
        <mapper resource="com/zjq/mapper/UserMapper.xml"></mapper>
    </mappers>


</configuration>
```

> åŸºäº Spring Cloud Alibaba + Gateway + Nacos + RocketMQ + Vue & Element å®ç°çš„åå°ç®¡ç†ç³»ç»Ÿ + ç”¨æˆ·å°ç¨‹åºï¼Œæ”¯æŒ RBAC åŠ¨æ€æƒé™ã€å¤šç§Ÿæˆ·ã€æ•°æ®æƒé™ã€å·¥ä½œæµã€ä¸‰æ–¹ç™»å½•ã€æ”¯ä»˜ã€çŸ­ä¿¡ã€å•†åŸç­‰åŠŸèƒ½
>
> - é¡¹ç›®åœ°å€ï¼šhttps://github.com/YunaiV/yudao-cloud
> - è§†é¢‘æ•™ç¨‹ï¼šhttps://doc.iocoder.cn/video/

## **[ä¸åˆ†æ‰¹æ¬¡ç›´æ¥æ¢­å“ˆ](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect)**

MyBatisç›´æ¥ä¸€æ¬¡æ€§æ‰¹é‡æ’å…¥30ä¸‡æ¡ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
@Test
public void testBatchInsertUser() throws IOException {
    InputStream resourceAsStream =
            Resources.getResourceAsStream("sqlMapConfig.xml");
    SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(resourceAsStream);
    SqlSession session = sqlSessionFactory.openSession();
    System.out.println("===== å¼€å§‹æ’å…¥æ•°æ® =====");
    long startTime = System.currentTimeMillis();
    try {
        List<User> userList = new ArrayList<>();
        for (int i = 1; i <= 300000; i++) {
            User user = new User();
            user.setId(i);
            user.setUsername("å…±é¥®ä¸€æ¯æ—  " + i);
            user.setAge((int) (Math.random() * 100));
            userList.add(user);
        }
        session.insert("batchInsertUser", userList); // æœ€åæ’å…¥å‰©ä½™çš„æ•°æ®
        session.commit();

        long spendTime = System.currentTimeMillis()-startTime;
        System.out.println("æˆåŠŸæ’å…¥ 30 ä¸‡æ¡æ•°æ®,è€—æ—¶ï¼š"+spendTime+"æ¯«ç§’");
    } finally {
        session.close();
    }
}
```

å¯ä»¥çœ‹åˆ°æ§åˆ¶å°è¾“å‡ºï¼š

> Cause: com.mysql.jdbc.PacketTooBigException: Packet for query is too large (27759038 >yun 4194304). You can change this value on the server by setting the max_allowed_packetâ€™ variable.

![å›¾ç‰‡](img\640-111126)

è¶…å‡ºæœ€å¤§æ•°æ®åŒ…é™åˆ¶äº†ï¼Œå¯ä»¥é€šè¿‡è°ƒæ•´`max_allowed_packet`é™åˆ¶æ¥æé«˜å¯ä»¥ä¼ è¾“çš„å†…å®¹ï¼Œä¸è¿‡ç”±äº30ä¸‡æ¡æ•°æ®è¶…å‡ºå¤ªå¤šï¼Œè¿™ä¸ªä¸å¯å–ï¼Œæ¢­å“ˆçœ‹æ¥æ˜¯ä¸è¡Œäº† ğŸ˜…ğŸ˜…ğŸ˜…

æ—¢ç„¶æ¢­å“ˆä¸è¡Œé‚£æˆ‘ä»¬å°±ä¸€æ¡ä¸€æ¡å¾ªç¯ç€æ’å…¥è¡Œä¸è¡Œå‘¢

## **[å¾ªç¯é€æ¡æ’å…¥](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect)**

mapperæ¥å£å’Œmapperæ–‡ä»¶ä¸­æ–°å¢å•ä¸ªç”¨æˆ·æ–°å¢çš„å†…å®¹å¦‚ä¸‹:

```
/**
 * æ–°å¢å•ä¸ªç”¨æˆ·
 * @param user
 */
void insertUser(User user);
<!-- æ–°å¢ç”¨æˆ·ä¿¡æ¯ -->
<insert id="insertUser" parameterType="user">
    insert into t_user(username,age) values
        (
        #{username},
        #{age}
        )
</insert>
```

è°ƒæ•´æ‰§è¡Œä»£ç å¦‚ä¸‹ï¼š

```
@Test
public void testCirculateInsertUser() throws IOException {
    InputStream resourceAsStream =
            Resources.getResourceAsStream("sqlMapConfig.xml");
    SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(resourceAsStream);
    SqlSession session = sqlSessionFactory.openSession();
    System.out.println("===== å¼€å§‹æ’å…¥æ•°æ® =====");
    long startTime = System.currentTimeMillis();
    try {
        for (int i = 1; i <= 300000; i++) {
            User user = new User();
            user.setId(i);
            user.setUsername("å…±é¥®ä¸€æ¯æ—  " + i);
            user.setAge((int) (Math.random() * 100));
            // ä¸€æ¡ä¸€æ¡æ–°å¢
            session.insert("insertUser", user);
            session.commit();
        }

        long spendTime = System.currentTimeMillis()-startTime;
        System.out.println("æˆåŠŸæ’å…¥ 30 ä¸‡æ¡æ•°æ®,è€—æ—¶ï¼š"+spendTime+"æ¯«ç§’");
    } finally {
        session.close();
    }
}
```

æ‰§è¡Œåå¯ä»¥å‘ç°ç£ç›˜IOå æ¯”é£™å‡ï¼Œä¸€ç›´å¤„äºé«˜ä½ã€‚

![å›¾ç‰‡](D:\work\nullnull\learn\learn-md\new\img\640-111127)

ç­‰å•Šç­‰ç­‰å•Šç­‰ï¼Œå¥½ä¹…è¿˜æ²¡æ‰§è¡Œå®Œ

![å›¾ç‰‡](D:\work\nullnull\learn\learn-md\new\img\640-111128)

å…ˆä¸ç®¡ä»–äº†å¤ªæ…¢äº†å…ˆæå…¶ä»–çš„ï¼Œç­‰ä¼šå†æ¥çœ‹çœ‹ç»“æœå§ã€‚

two thousand year later â€¦

æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š

![å›¾ç‰‡](img\640-111124)

æ€»å…±æ‰§è¡Œäº†14909367æ¯«ç§’ï¼Œæ¢ç®—å‡ºæ¥æ˜¯4å°æ—¶å…«åˆ†é’Ÿã€‚å¤ªæ…¢äº†ã€‚ã€‚

![å›¾ç‰‡](img\640-11123)

è¿˜æ˜¯ä¼˜åŒ–ä¸‹ä¹‹å‰çš„æ‰¹å¤„ç†æ–¹æ¡ˆå§

## **[MyBatiså®ç°æ’å…¥30ä¸‡æ¡æ•°æ®](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect)**

å…ˆæ¸…ç†è¡¨æ•°æ®ï¼Œç„¶åä¼˜åŒ–æ‰¹å¤„ç†æ‰§è¡Œæ’å…¥ï¼š

```
-- æ¸…ç©ºç”¨æˆ·è¡¨
TRUNCATE table  t_user;
```

ä»¥ä¸‹æ˜¯é€šè¿‡ MyBatis å®ç° 30 ä¸‡æ¡æ•°æ®æ’å…¥ä»£ç å®ç°ï¼š

```
/**
 * åˆ†æ‰¹æ¬¡æ‰¹é‡æ’å…¥
 * @throws IOException
 */
@Test
public void testBatchInsertUser() throws IOException {
    InputStream resourceAsStream =
            Resources.getResourceAsStream("sqlMapConfig.xml");
    SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(resourceAsStream);
    SqlSession session = sqlSessionFactory.openSession();
    System.out.println("===== å¼€å§‹æ’å…¥æ•°æ® =====");
    long startTime = System.currentTimeMillis();
    int waitTime = 10;
    try {
        List<User> userList = new ArrayList<>();
        for (int i = 1; i <= 300000; i++) {
            User user = new User();
            user.setId(i);
            user.setUsername("å…±é¥®ä¸€æ¯æ—  " + i);
            user.setAge((int) (Math.random() * 100));
            userList.add(user);
            if (i % 1000 == 0) {
                session.insert("batchInsertUser", userList);
                // æ¯ 1000 æ¡æ•°æ®æäº¤ä¸€æ¬¡äº‹åŠ¡
                session.commit();
                userList.clear();

                // ç­‰å¾…ä¸€æ®µæ—¶é—´
                Thread.sleep(waitTime * 1000);
            }
        }
        // æœ€åæ’å…¥å‰©ä½™çš„æ•°æ®
        if(!CollectionUtils.isEmpty(userList)) {
            session.insert("batchInsertUser", userList);
            session.commit();
        }

        long spendTime = System.currentTimeMillis()-startTime;
        System.out.println("æˆåŠŸæ’å…¥ 30 ä¸‡æ¡æ•°æ®,è€—æ—¶ï¼š"+spendTime+"æ¯«ç§’");
    } catch (Exception e) {
        e.printStackTrace();
    } finally {
        session.close();
    }
}
```

ä½¿ç”¨äº† MyBatis çš„æ‰¹å¤„ç†æ“ä½œï¼Œå°†æ¯ 1000 æ¡æ•°æ®æ”¾åœ¨ä¸€ä¸ªæ‰¹æ¬¡ä¸­æ’å…¥ï¼Œèƒ½å¤Ÿè¾ƒä¸ºæœ‰æ•ˆåœ°æé«˜æ’å…¥é€Ÿåº¦ã€‚åŒæ—¶è¯·æ³¨æ„åœ¨å¾ªç¯æ’å…¥æ—¶è¦å¸¦æœ‰åˆé€‚çš„ç­‰å¾…æ—¶é—´å’Œæ‰¹å¤„ç†å¤§å°ï¼Œä»¥é˜²æ­¢å‡ºç°å†…å­˜å ç”¨è¿‡é«˜ç­‰é—®é¢˜ã€‚æ­¤å¤–ï¼Œè¿˜éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®åˆç†çš„è¿æ¥æ± å’Œæ•°æ®åº“çš„å‚æ•°ï¼Œä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚

![å›¾ç‰‡](img\640-12312319876.png)

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æ¯æ’å…¥1000è¡Œæ•°æ®å°±è¿›è¡Œä¸€æ¬¡æ‰¹å¤„ç†æäº¤ï¼Œå¹¶ç­‰å¾…10ç§’é’Ÿã€‚è¿™æœ‰åŠ©äºæ§åˆ¶å†…å­˜å ç”¨ï¼Œå¹¶ç¡®ä¿æ’å…¥æ“ä½œå¹³ç¨³è¿›è¡Œã€‚

![å›¾ç‰‡](D:\work\nullnull\learn\learn-md\new\img\640-111129)

äº”ååˆ†é’Ÿæ‰§è¡Œå®Œæ¯•ï¼Œæ—¶é—´ä¸»è¦ç”¨åœ¨äº†ç­‰å¾…ä¸Šã€‚

å¦‚æœä½è°·æ—¶æœŸæ‰§è¡Œï¼ŒCPUå’Œç£ç›˜æ€§èƒ½åˆè¶³å¤Ÿçš„æƒ…å†µä¸‹ï¼Œç›´æ¥æ‰¹å¤„ç†ä¸ç­‰å¾…æ‰§è¡Œï¼š

```
/**
 * åˆ†æ‰¹æ¬¡æ‰¹é‡æ’å…¥
 * @throws IOException
 */
@Test
public void testBatchInsertUser() throws IOException {
    InputStream resourceAsStream =
            Resources.getResourceAsStream("sqlMapConfig.xml");
    SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(resourceAsStream);
    SqlSession session = sqlSessionFactory.openSession();
    System.out.println("===== å¼€å§‹æ’å…¥æ•°æ® =====");
    long startTime = System.currentTimeMillis();
    int waitTime = 10;
    try {
        List<User> userList = new ArrayList<>();
        for (int i = 1; i <= 300000; i++) {
            User user = new User();
            user.setId(i);
            user.setUsername("å…±é¥®ä¸€æ¯æ—  " + i);
            user.setAge((int) (Math.random() * 100));
            userList.add(user);
            if (i % 1000 == 0) {
                session.insert("batchInsertUser", userList);
                // æ¯ 1000 æ¡æ•°æ®æäº¤ä¸€æ¬¡äº‹åŠ¡
                session.commit();
                userList.clear();
            }
        }
        // æœ€åæ’å…¥å‰©ä½™çš„æ•°æ®
        if(!CollectionUtils.isEmpty(userList)) {
            session.insert("batchInsertUser", userList);
            session.commit();
        }

        long spendTime = System.currentTimeMillis()-startTime;
        System.out.println("æˆåŠŸæ’å…¥ 30 ä¸‡æ¡æ•°æ®,è€—æ—¶ï¼š"+spendTime+"æ¯«ç§’");
    } catch (Exception e) {
        e.printStackTrace();
    } finally {
        session.close();
    }
}
```

åˆ™24ç§’å¯ä»¥å®Œæˆæ•°æ®æ’å…¥æ“ä½œï¼š

![å›¾ç‰‡](img\640-1231231.png)

![å›¾ç‰‡](img\640-222222222.png)

å¯ä»¥çœ‹åˆ°çŸ­æ—¶CPUå’Œç£ç›˜å ç”¨ä¼šé£™é«˜ã€‚

æŠŠæ‰¹å¤„ç†çš„é‡å†è°ƒå¤§ä¸€äº›è°ƒåˆ°5000ï¼Œåœ¨æ‰§è¡Œï¼š

![å›¾ç‰‡](D:\work\nullnull\learn\learn-md\new\img\640-111130)

13ç§’æ’å…¥æˆåŠŸ30ä¸‡æ¡ï¼Œç›´æ¥èŠœæ¹–èµ·é£ğŸ›«ğŸ›«ğŸ›«

## **[JDBCå®ç°æ’å…¥30ä¸‡æ¡æ•°æ®](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect)**

JDBCå¾ªç¯æ’å…¥çš„è¯è·Ÿä¸Šé¢çš„mybatisé€æ¡æ’å…¥ç±»ä¼¼ï¼Œä¸å†èµ˜è¿°ã€‚

ä»¥ä¸‹æ˜¯ Java ä½¿ç”¨ JDBC æ‰¹å¤„ç†å®ç° 30 ä¸‡æ¡æ•°æ®æ’å…¥çš„ç¤ºä¾‹ä»£ç ã€‚è¯·æ³¨æ„ï¼Œè¯¥ä»£ç ä»…æä¾›æ€è·¯ï¼Œå…·ä½“å®ç°éœ€æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œä¿®æ”¹ã€‚

```
/**
 * JDBCåˆ†æ‰¹æ¬¡æ‰¹é‡æ’å…¥
 * @throws IOException
 */
@Test
public void testJDBCBatchInsertUser() throws IOException {
    Connection connection = null;
    PreparedStatement preparedStatement = null;

    String databaseURL = "jdbc:mysql://localhost:3306/test";
    String user = "root";
    String password = "root";

    try {
        connection = DriverManager.getConnection(databaseURL, user, password);
        // å…³é—­è‡ªåŠ¨æäº¤äº‹åŠ¡ï¼Œæ”¹ä¸ºæ‰‹åŠ¨æäº¤
        connection.setAutoCommit(false);
        System.out.println("===== å¼€å§‹æ’å…¥æ•°æ® =====");
        long startTime = System.currentTimeMillis();
        String sqlInsert = "INSERT INTO t_user ( username, age) VALUES ( ?, ?)";
        preparedStatement = connection.prepareStatement(sqlInsert);

        Random random = new Random();
        for (int i = 1; i <= 300000; i++) {
            preparedStatement.setString(1, "å…±é¥®ä¸€æ¯æ—  " + i);
            preparedStatement.setInt(2, random.nextInt(100));
            // æ·»åŠ åˆ°æ‰¹å¤„ç†ä¸­
            preparedStatement.addBatch();

            if (i % 1000 == 0) {
                // æ¯1000æ¡æ•°æ®æäº¤ä¸€æ¬¡
                preparedStatement.executeBatch();
                connection.commit();
                System.out.println("æˆåŠŸæ’å…¥ç¬¬ "+ i+" æ¡æ•°æ®");
            }

        }
        // å¤„ç†å‰©ä½™çš„æ•°æ®
        preparedStatement.executeBatch();
        connection.commit();
        long spendTime = System.currentTimeMillis()-startTime;
        System.out.println("æˆåŠŸæ’å…¥ 30 ä¸‡æ¡æ•°æ®,è€—æ—¶ï¼š"+spendTime+"æ¯«ç§’");
    } catch (SQLException e) {
        System.out.println("Error: " + e.getMessage());
    } finally {
        if (preparedStatement != null) {
            try {
                preparedStatement.close();
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }

        if (connection != null) {
            try {
                connection.close();
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }
    }
}
```

![å›¾ç‰‡](img\data.png)

![å›¾ç‰‡](img\640-111131)

ä¸Šè¿°ç¤ºä¾‹ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ JDBC è¿æ¥ MySQL æ•°æ®åº“ï¼Œå¹¶æ‰§è¡Œæ‰¹å¤„ç†æ“ä½œæ’å…¥æ•°æ®ã€‚å…·ä½“å®ç°æ­¥éª¤å¦‚ä¸‹ï¼š

- è·å–æ•°æ®åº“è¿æ¥ã€‚
- åˆ›å»º Statement å¯¹è±¡ã€‚
- å®šä¹‰ SQL è¯­å¥ï¼Œä½¿ç”¨ `PreparedStatement` å¯¹è±¡é¢„ç¼–è¯‘ SQL è¯­å¥å¹¶è®¾ç½®å‚æ•°ã€‚
- æ‰§è¡Œæ‰¹å¤„ç†æ“ä½œã€‚
- å¤„ç†å‰©ä½™çš„æ•°æ®ã€‚
- å…³é—­ Statement å’Œ Connection å¯¹è±¡ã€‚

ä½¿ç”¨`setAutoCommit(false) `æ¥ç¦æ­¢è‡ªåŠ¨æäº¤äº‹åŠ¡ï¼Œç„¶ååœ¨æ¯æ¬¡æ‰¹é‡æ’å…¥ä¹‹åæ‰‹åŠ¨æäº¤äº‹åŠ¡ã€‚æ¯æ¬¡æ’å…¥æ•°æ®æ—¶éƒ½æ–°å»ºä¸€ä¸ª `PreparedStatement` å¯¹è±¡ä»¥é¿å…çŠ¶æ€ä¸ä¸€è‡´é—®é¢˜ã€‚åœ¨æ’å…¥æ•°æ®çš„å¾ªç¯ä¸­ï¼Œæ¯ 10000 æ¡æ•°æ®å°±æ‰§è¡Œä¸€æ¬¡ `executeBatch()` æ’å…¥æ•°æ®ã€‚

å¦å¤–ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µä¼˜åŒ–è¿æ¥æ± å’Œæ•°æ®åº“çš„ç›¸å…³é…ç½®ï¼Œä»¥é˜²æ­¢è¿æ¥è¶…æ—¶ç­‰é—®é¢˜ã€‚

## **[æ€»ç»“](https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect)**

å®ç°é«˜æ•ˆçš„å¤§é‡æ•°æ®æ’å…¥éœ€è¦ç»“åˆä»¥ä¸‹ä¼˜åŒ–ç­–ç•¥ï¼ˆå»ºè®®ç»¼åˆä½¿ç”¨ï¼‰ï¼š

**1.æ‰¹å¤„ç†ï¼š** æ‰¹é‡æäº¤SQLè¯­å¥å¯ä»¥é™ä½ç½‘ç»œä¼ è¾“å’Œå¤„ç†å¼€é”€ï¼Œå‡å°‘ä¸æ•°æ®åº“äº¤äº’çš„æ¬¡æ•°ã€‚åœ¨Javaä¸­å¯ä»¥ä½¿ç”¨Statementæˆ–è€…`PreparedStatement`çš„`addBatch()`æ–¹æ³•æ¥æ·»åŠ å¤šä¸ªSQLè¯­å¥ï¼Œç„¶åä¸€æ¬¡æ€§æ‰§è¡Œ`executeBatch()`æ–¹æ³•æäº¤æ‰¹å¤„ç†çš„SQLè¯­å¥ã€‚

- åœ¨å¾ªç¯æ’å…¥æ—¶å¸¦æœ‰é€‚å½“çš„ç­‰å¾…æ—¶é—´å’Œæ‰¹å¤„ç†å¤§å°ï¼Œä»è€Œé¿å…å†…å­˜å ç”¨è¿‡é«˜ç­‰é—®é¢˜ï¼š

- - è®¾ç½®é€‚å½“çš„æ‰¹å¤„ç†å¤§å°ï¼šæ‰¹å¤„ç†å¤§å°æŒ‡åœ¨ä¸€æ¬¡æ’å…¥æ“ä½œä¸­æ’å…¥å¤šå°‘è¡Œæ•°æ®ã€‚å¦‚æœæ‰¹å¤„ç†å¤§å°å¤ªå°ï¼Œæ’å…¥æ“ä½œçš„é¢‘ç‡å°†å¾ˆé«˜ï¼Œè€Œå¦‚æœæ‰¹å¤„ç†å¤§å°å¤ªå¤§ï¼Œå¯èƒ½ä¼šå¯¼è‡´å†…å­˜å ç”¨è¿‡é«˜ã€‚é€šå¸¸ï¼Œå»ºè®®å°†æ‰¹å¤„ç†å¤§å°è®¾ç½®ä¸º1000-5000è¡Œï¼Œè¿™å°†å‡å°‘æ’å…¥æ“ä½œçš„é¢‘ç‡å¹¶é™ä½å†…å­˜å ç”¨ã€‚
  - é‡‡ç”¨é€‚å½“çš„ç­‰å¾…æ—¶é—´ï¼šç­‰å¾…æ—¶é—´æŒ‡åœ¨æ‰¹å¤„ç†æ“ä½œä¹‹é—´ç­‰å¾…çš„æ—¶é—´é‡ã€‚ç­‰å¾…æ—¶é—´è¿‡çŸ­å¯èƒ½ä¼šå¯¼è‡´å†…å­˜å ç”¨è¿‡é«˜ï¼Œè€Œç­‰å¾…æ—¶é—´è¿‡é•¿åˆ™å¯èƒ½ä¼šå»¶è¿Ÿæ’å…¥æ“ä½œçš„é€Ÿåº¦ã€‚é€šå¸¸ï¼Œå»ºè®®å°†ç­‰å¾…æ—¶é—´è®¾ç½®ä¸ºå‡ ç§’é’Ÿåˆ°å‡ åç§’é’Ÿä¹‹é—´ï¼Œè¿™å°†ä½¿æ“ä½œå˜å¾—å¹³æ»‘ä¸”é¿å…å‡ºç°å†…å­˜å ç”¨è¿‡é«˜ç­‰é—®é¢˜ã€‚
  - å¯ä»¥è€ƒè™‘ä½¿ç”¨ä¸€äº›å†…å­˜ä¼˜åŒ–çš„æŠ€å·§ï¼Œä¾‹å¦‚ä½¿ç”¨å†…å­˜æ•°æ®åº“æˆ–ä½¿ç”¨æ¸¸æ ‡æ–¹å¼æ’å…¥æ•°æ®ï¼Œä»¥å‡å°‘å†…å­˜å ç”¨ã€‚

- æ€»çš„æ¥è¯´ï¼Œé€‰æ‹©é€‚å½“çš„æ‰¹å¤„ç†å¤§å°å’Œç­‰å¾…æ—¶é—´å¯ä»¥å¸®åŠ©æ‚¨å¹³ç¨³åœ°è¿›è¡Œæ’å…¥æ“ä½œï¼Œé¿å…å‡ºç°å†…å­˜å ç”¨è¿‡é«˜ç­‰é—®é¢˜ã€‚

**2.ç´¢å¼•:** åœ¨å¤§é‡æ•°æ®æ’å…¥å‰æš‚æ—¶å»æ‰ç´¢å¼•ï¼Œæœ€åå†æ‰“ä¸Šï¼Œè¿™æ ·å¯ä»¥å¤§å¤§å‡å°‘å†™å…¥æ—¶å€™çš„æ›´æ–°ç´¢å¼•çš„æ—¶é—´ã€‚

**3.æ•°æ®åº“è¿æ¥æ± ï¼š** ä½¿ç”¨æ•°æ®åº“è¿æ¥æ± å¯ä»¥å‡å°‘æ•°æ®åº“è¿æ¥å»ºç«‹å’Œå…³é—­çš„å¼€é”€ï¼Œæé«˜æ€§èƒ½ã€‚åœ¨æ²¡æœ‰ä½¿ç”¨æ•°æ®åº“è¿æ¥æ± çš„æƒ…å†µï¼Œè®°å¾—åœ¨finallyä¸­å…³é—­ç›¸å…³è¿æ¥ã€‚

æ•°æ®åº“å‚æ•°è°ƒæ•´ï¼šå¢åŠ MySQLæ•°æ®åº“ç¼“å†²åŒºå¤§å°ã€é…ç½®é«˜æ€§èƒ½çš„ç£ç›˜å’ŒI/Oç­‰ã€‚

------

